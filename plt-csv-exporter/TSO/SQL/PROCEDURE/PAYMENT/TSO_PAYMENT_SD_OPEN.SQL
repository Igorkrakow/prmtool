CREATE or replace PROCEDURE TXSTORE.TSO_PAYMENT_SD_OPEN(start_time TIMESTAMP, end_time TIMESTAMP)
    LANGUAGE SQL
BEGIN
    DECLARE SQLCODE INT DEFAULT 0;
    DECLARE V_SQLCODE INT DEFAULT 0;

    DECLARE V_WAGER_LOTTERY_TX_HEADER_ID BIGINT;
    DECLARE V_START_DRAW_NUMBER INTEGER;


    DECLARE V_COUNT_COMMIT BIGINT;


    DECLARE MIGRATED_TX_CURSOR CURSOR WITH HOLD FOR
        SELECT
            LTHW.LOTTERY_TX_HEADER_ID,
            LTHW.START_DRAW_NUMBER
        FROM TXSTORE.LOTTERY_TX_HEADER LTHW
                 JOIN TXSTORE.TX_HEADER THW ON THW.TX_HEADER_ID = LTHW.LOTTERY_TX_HEADER_ID
            AND LTHW.LOTTERY_TRANSACTION_TYPE = 'WAGER'
            AND TRANSACTION_TIME_LOCAL >= start_time AND TRANSACTION_TIME_LOCAL < end_time

                 JOIN GIS.DGGAME ON LTHW.PRODUCT = GIS.DGGAME.HOSTPRODUCTNUMBER

-- Closed wagers only
                 JOIN TXSTORE.LAST_CLOSED ON GIS.DGGAME.IDDGGAME = TXSTORE.LAST_CLOSED.IDDGGAME
            AND END_DRAW_NUMBER > TXSTORE.LAST_CLOSED.DRAWNUMBER
    WHERE START_DRAW_NUMBER = END_DRAW_NUMBER;
    -- Only migrate allowed player IDs
--JOIN PAM_CMD.SMS_CONTRACT_MIGRATION ON CONTRACT_IDENTITY = TXSTORE.TX_HEADER.PLAYER_ID




    DECLARE CONTINUE HANDLER FOR SQLEXCEPTION, NOT FOUND, SQLWARNING
        SET V_SQLCODE = SQLCODE;
    OPEN MIGRATED_TX_CURSOR;
    CALL SYSIBMADM.DBMS_OUTPUT.PUT_LINE('Open and start reading the "TSO_PURCHASE_CURSOR" cursor.');
    FETCH MIGRATED_TX_CURSOR
        INTO V_WAGER_LOTTERY_TX_HEADER_ID, V_START_DRAW_NUMBER;
    SET V_COUNT_COMMIT = 1;
    WHILE (V_SQLCODE = 0)
        DO
            INSERT INTO TXSTORE.TMP_TSO_OPEN_PAYMENT_TRANSACTION (TRANSACTION_ID,CHECK_DRAW_FROM,SD_OR_MD)
            VALUES (V_WAGER_LOTTERY_TX_HEADER_ID,V_START_DRAW_NUMBER,1);

            IF(V_COUNT_COMMIT = 10000) THEN
                SET V_COUNT_COMMIT = 1;
                COMMIT ;
            ELSE
                SET V_COUNT_COMMIT = V_COUNT_COMMIT + 1;
            end if;
            SET V_SQLCODE = 0;
            FETCH MIGRATED_TX_CURSOR
                INTO V_WAGER_LOTTERY_TX_HEADER_ID, V_START_DRAW_NUMBER;
            IF (V_SQLCODE <> 0) THEN
                CALL SYSIBMADM.DBMS_OUTPUT.PUT_LINE(
                            'Finish reading the cursor.' || V_SQLCODE);
            END IF;
        END WHILE;
    CLOSE MIGRATED_TX_CURSOR;
    CALL SYSIBMADM.DBMS_OUTPUT.PUT_LINE('Close the "TSO_PURCHASE_CURSOR" cursor.');
END
;

