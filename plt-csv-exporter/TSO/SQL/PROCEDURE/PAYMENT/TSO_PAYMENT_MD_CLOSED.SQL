insert into TXSTORE.TMP_TSO_PAYMENT(TRANSACTION_ID, PLAYER_ID, STATUS, DRAW, TRANSACTION_DATE, UUID,
                                    PRODUCT, AMOUNT, GLOBAL_TRANS_ID,
                                    START_DATE_RUN, END_DATE_RUN,
                                    START_DATE_UPDATE, END_DATE_UPDATE, DELTA)
SELECT
    LTHW.LOTTERY_TX_HEADER_ID,
    THW.PLAYER_ID,
    CASE WHEN NVL(VAL.TRANSACTION_AMOUNT,0)   > 0
             THEN 'WINNING'
         ELSE 'LOSER' END as status,
    e.DRAWNUMBER,
    CASE WHEN VAL.TRANSACTION_TIME_LOCAL IS NULL THEN LTHW.TRANSACTION_TIME_LOCAL
         ELSE VAL.TRANSACTION_TIME_LOCAL END as date,
    CASE WHEN LTV.UUID IS NULL THEN THW.UUID
         ELSE LTV.UUID END as uuid,
    lthw.PRODUCT,
    NVL(VAL.TRANSACTION_AMOUNT,0),
    LTHW.GLOBAL_TRANS_ID,
    '2019-11-25 00:00:00.000000',
    '2019-12-25 00:00:00.000000',
    '2019-11-25 00:00:00.000000',
    '2019-12-25 00:00:00.000000',
    'i'
FROM TXSTORE.LOTTERY_TX_HEADER LTHW
         JOIN TXSTORE.TX_HEADER THW ON THW.TX_HEADER_ID = LTHW.LOTTERY_TX_HEADER_ID
    AND LTHW.LOTTERY_TRANSACTION_TYPE = 'WAGER'
    AND LTHW.TRANSACTION_TIME_LOCAL >= '2019-11-25 00:00:00.000000' AND LTHW.TRANSACTION_TIME_LOCAL < '2019-12-25 00:00:00.000000'
-- Closed wagers only
         JOIN TXSTORE.LAST_CLOSED ON lthw.PRODUCT = TXSTORE.LAST_CLOSED.IDDGGAME
    AND END_DRAW_NUMBER <= TXSTORE.LAST_CLOSED.DRAWNUMBER
         join  gis.DGGAMEEVENT e on e.DRAWNUMBER between lthw.START_DRAW_NUMBER and lthw.END_DRAW_NUMBER and e.IDDGGAME = lthw.PRODUCT
         LEFT JOIN TXSTORE.LOTTERY_TX_HEADER  VAL ON val.LOTTERY_TRANSACTION_TYPE = 'VALIDATION' AND (
        (lthw.GLOBAL_TRANS_ID = VAL.GLOBAL_TRANS_ID AND lthw.SERIAL = VAL.SERIAL and lthw.START_DRAW_NUMBER = e.DRAWNUMBER) OR
        (lthw.CDC = VAL.CDC AND lthw.SERIAL = VAL.SERIAL  and lthw.START_DRAW_NUMBER = e.DRAWNUMBER AND lthw.GLOBAL_TRANS_ID != VAL.GLOBAL_TRANS_ID))
         left join TXSTORE.TX_HEADER LTV on VAL.LOTTERY_TX_HEADER_ID = LTV.TX_HEADER_ID
             WHERE LTHW.START_DRAW_NUMBER != LTHW.END_DRAW_NUMBER;