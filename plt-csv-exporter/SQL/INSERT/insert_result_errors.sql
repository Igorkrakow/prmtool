INSERT INTO TXSTORE.MIGRATION_ERRORS (TABLE_NAME, ID, STATUS)
SELECT
    'MIGRATED_RESULTS',
    TX_TRANSACTION_ID,
    'RESULT.Validations for dirty WAGERS(without start-end draw id)' as name
FROM
    (SELECT MTV.TX_TRANSACTION_ID FROM TXSTORE.MIGRATED_TX_TRANSACTION t
                                           join TXSTORE.MIGRATED_TX_TRANSACTION MTV
                                                on  MTV.GLOBAL_TRANS_ID=t.GLOBAL_TRANS_ID
                                                    and MTV.SERIAL=t.SERIAL
                                                    and MTV.TRANSACTION_TYPE='VALIDATION'
     where t.TRANSACTION_TYPE = 'WAGER' and t.START_DRAW_NUMBER is null
     UNION ALL
     SELECT MTV.TX_TRANSACTION_ID FROM TXSTORE.MIGRATED_TX_TRANSACTION t
                                           join TXSTORE.MIGRATED_TX_TRANSACTION MTV
                                                on  MTV.SERIAL=t.SERIAL
                                                    and MTV.TRANSACTION_TYPE='VALIDATION'
                                                    and MTV.PLAYER_ID =t.PLAYER_ID
     where t.TRANSACTION_TYPE = 'WAGER' and t.START_DRAW_NUMBER is null
       and MTV.START_DRAW_NUMBER between t.START_DRAW_NUMBER and t.END_DRAW_NUMBER
       and MTV.GLOBAL_TRANS_ID != t.GLOBAL_TRANS_ID)
@
INSERT INTO TXSTORE.MIGRATION_ERRORS (TABLE_NAME, ID, STATUS)
SELECT 'MIGRATED_RESULTS',
        MTTV.TX_TRANSACTION_ID,
       'Result validation with wagers_before_first_day_of_run'
FROM TXSTORE.MIGRATED_TX_TRANSACTION MTTV
JOIN (
    SELECT W.LOTTERY_TX_HEADER_ID, W.GLOBAL_TRANS_ID, W.SERIAL,
           W.CDC,W.PLAYER_ID,W.START_DRAW_NUMBER,W.END_DRAW_NUMBER
    FROM (SELECT LTH.LOTTERY_TX_HEADER_ID, LTH.GLOBAL_TRANS_ID, LTH.SERIAL, LTH.CDC,TH.PLAYER_ID,
                 LTH.START_DRAW_NUMBER,LTH.END_DRAW_NUMBER
          FROM TXSTORE.LOTTERY_TX_HEADER LTH
          JOIN TXSTORE.TX_HEADER TH ON LTH.LOTTERY_TX_HEADER_ID = TH.TX_HEADER_ID
          WHERE LTH.LOTTERY_TRANSACTION_TYPE = 'WAGER'
                AND (TH.TX_HEADER_ID < (case when (SELECT TX_HEADER_ID FROM TXSTORE.TX_HEADER where uuid = (SELECT UUID FROM TXSTORE.MIGRATED_TX_DRAW_ENTRY FETCH FIRST 1 ROW ONLY) ) is null
                                               or (SELECT TX_HEADER_ID FROM TXSTORE.TX_HEADER where uuid = (SELECT UUID FROM TXSTORE.MIGRATED_TX_DRAW_ENTRY FETCH FIRST 1 ROW ONLY) )>(SELECT min(TX_HEADER_ID) from TXSTORE.MIGR_TX_HEADER)
                                        then (SELECT min(TX_HEADER_ID) from TXSTORE.MIGR_TX_HEADER)
                                        else (SELECT TX_HEADER_ID FROM TXSTORE.TX_HEADER where uuid = (SELECT UUID FROM TXSTORE.MIGRATED_TX_DRAW_ENTRY FETCH FIRST 1 ROW ONLY))
                                        end
                                        ) OR TH.TX_HEADER_ID > (SELECT max(TX_HEADER_ID) from TXSTORE.MIGR_TX_HEADER))
         ) W
    JOIN (
          SELECT MTH.GLOBAL_TRANS_ID, MTH.SERIAL, MTH.CDC,MTH.PLAYER_ID,MTH.START_DRAW_NUMBER
          FROM TXSTORE.MIGRATED_TX_TRANSACTION MTH
          WHERE MTH.TRANSACTION_TYPE = 'VALIDATION'
                AND MTH.TX_TRANSACTION_ID NOT IN (SELECT LOTTERY_TX_HEADER_ID FROM TXSTORE.MIGRATED_RESULTS)
         ) V
           ON (W.GLOBAL_TRANS_ID = V.GLOBAL_TRANS_ID AND W.SERIAL = V.SERIAL)
           OR (W.SERIAL = V.SERIAL and W.GLOBAL_TRANS_ID != V.GLOBAL_TRANS_ID and W.PLAYER_ID=V.PLAYER_ID)
           WHERE V.START_DRAW_NUMBER between W.START_DRAW_NUMBER and W.END_DRAW_NUMBER
    ) R
     ON (MTTV.GLOBAL_TRANS_ID = R.GLOBAL_TRANS_ID AND MTTV.SERIAL = R.SERIAL)
     OR( MTTV.SERIAL = R.SERIAL AND MTTV.GLOBAL_TRANS_ID != R.GLOBAL_TRANS_ID and MTTV.PLAYER_ID=R.PLAYER_ID)
WHERE MTTV.TRANSACTION_TYPE = 'VALIDATION'
and MTTV.START_DRAW_NUMBER between R.START_DRAW_NUMBER and R.END_DRAW_NUMBER
@

INSERT INTO TXSTORE.MIGRATION_ERRORS (TABLE_NAME, ID, STATUS)
SELECT
    'MIGRATED_RESULTS',
    LTV.TX_TRANSACTION_ID,
    'RESULT.VALIDATIONs without WAGERs'
FROM TXSTORE.MIGRATED_TX_TRANSACTION LTV
WHERE LTV.TRANSACTION_TYPE='VALIDATION'
    AND LTV.TX_TRANSACTION_ID NOT IN    (SELECT v.TX_TRANSACTION_ID from
                                            (  SELECT LTH.GLOBAL_TRANS_ID, LTH.SERIAL, LTH.CDC,LTH.START_DRAW_NUMBER,LTH.END_DRAW_NUMBER,TH.PLAYER_ID
                                               FROM TXSTORE.LOTTERY_TX_HEADER LTH
                                                        JOIN TXSTORE.TX_HEADER TH ON LTH.LOTTERY_TX_HEADER_ID = TH.TX_HEADER_ID
                                               WHERE LTH.LOTTERY_TRANSACTION_TYPE = 'WAGER'
                                            ) as W
                                                JOIN ( SELECT MTH.TX_TRANSACTION_ID, MTH.GLOBAL_TRANS_ID, MTH.SERIAL, MTH.CDC,MTH.START_DRAW_NUMBER,MTH.PLAYER_ID
                                                       FROM TXSTORE.MIGRATED_TX_TRANSACTION MTH
                                                       WHERE MTH.TRANSACTION_TYPE = 'VALIDATION'
                                            ) as V ON (W.GLOBAL_TRANS_ID = V.GLOBAL_TRANS_ID AND W.SERIAL = V.SERIAL)
                                                OR (W.SERIAL = V.SERIAL and W.GLOBAL_TRANS_ID != V.GLOBAL_TRANS_ID and W.PLAYER_ID=V.PLAYER_ID)
                                         WHERE V.START_DRAW_NUMBER BETWEEN W.START_DRAW_NUMBER and W.END_DRAW_NUMBER
                                        )
@

INSERT INTO TXSTORE.MIGRATION_ERRORS (TABLE_NAME, ID, STATUS)
SELECT 'MIGRATED_RESULTS',
       V.TX_TRANSACTION_ID,
       'VALIDATION LINKED TO WAGER WITH DIFFERENT DRAW NUMBERS'
FROM (  SELECT LTH.GLOBAL_TRANS_ID, LTH.SERIAL, LTH.CDC,LTH.START_DRAW_NUMBER,LTH.END_DRAW_NUMBER,TH.PLAYER_ID
        FROM TXSTORE.MIGRATED_TX_TRANSACTION LTH
        JOIN TXSTORE.TX_HEADER TH ON LTH.TX_TRANSACTION_ID = TH.TX_HEADER_ID
        WHERE LTH.TRANSACTION_TYPE = 'WAGER'
     ) as W
JOIN (
    SELECT MTH.TX_TRANSACTION_ID, MTH.GLOBAL_TRANS_ID, MTH.SERIAL, MTH.CDC,MTH.START_DRAW_NUMBER,MTH.PLAYER_ID
    FROM TXSTORE.MIGRATED_TX_TRANSACTION MTH
    WHERE MTH.TRANSACTION_TYPE = 'VALIDATION'
      AND MTH.TX_TRANSACTION_ID NOT IN (SELECT LOTTERY_TX_HEADER_ID FROM TXSTORE.MIGRATED_RESULTS)
    ) as V
    ON (W.GLOBAL_TRANS_ID = V.GLOBAL_TRANS_ID AND W.SERIAL = V.SERIAL)
    OR (W.SERIAL = V.SERIAL and W.GLOBAL_TRANS_ID != V.GLOBAL_TRANS_ID and W.PLAYER_ID=V.PLAYER_ID)
WHERE V.START_DRAW_NUMBER NOT BETWEEN W.START_DRAW_NUMBER and W.END_DRAW_NUMBER
and v.TX_TRANSACTION_ID not in (SELECT ID FROM TXSTORE.MIGRATION_ERRORS)
@